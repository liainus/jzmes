<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>工作台</title>
    <link href="../static/css/base.css" rel="stylesheet">
	<link rel="stylesheet" href="../static/custom/uimaker/easyui.css">
    <link rel="stylesheet" href="../static/css/bootstrap.min.css">
    <link rel="stylesheet" href="../static/css/bootstrap-table.min.css">
    <link rel="stylesheet" href="../static/css/bootstrap-datetimepicker.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="../static/css/fullcalendar.min.css">
    <style>
        .content{
            background: #eaedf2;
            padding:20px 10px;
        }
        .AgencyArea{
            position: relative;
            font-size: 12px;
        }
        .AgencyArea .AgencyArea-item{
            background: #00c4dc;
            color: #fff;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 3px;
            cursor: pointer;
        }
        .AgencyArea-head{
            border-bottom: 1px solid #FFF;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .text-muted{
            color: #333;
        }
        .panel-body{
            border:none;
        }
        .fc-toolbar h2{
            font-size: 18px;
            line-height: 30px;
        }
        .fc-event{
            line-height: 1;
        }
        .fc-content-skeleton td{
            text-align: center;
        }
        .fc-ltr .fc-basic-view .fc-day-top .fc-day-number{
            float: none;
        }
        .bg-proceed{
            padding: 6px 10px;
            color: #fff;
            margin: 10px 0;
            border-radius: 3px;
            background: #00c3db;
        }
        .bg-backlog{
            padding: 6px 10px;
            color: #fff;
            margin: 10px 0;
            border-radius: 3px;
            background: #f7d013;
        }
        .bg-urgency{
            padding: 6px 10px;
            color: #fff;
            margin: 10px 0;
            border-radius: 3px;
            background: #e73b3b;
        }
    </style>
</head>
<body>
    <div class="modal" id="loadingModal" data-backdrop="static" data-keyboard="false">
        <div style="width: 200px;height:20px; z-index: 20000; position: absolute; text-align: center; left: 50%; top: 50%;margin-left:-100px;margin-top:-10px">
            <div class="progress progress-striped active" style="margin-bottom: 0;">
                <div class="progress-bar" style="width: 100%;"></div>
            </div>
            <h5>正在加载...</h5>
        </div>
    </div>
    <div class="content clearfix">
        <div class="col-md-12">
            <div class="row">
                <div class="col-md-8 col-sm-12">
                    <div class="row AgencyArea">
                        <div class="col-md-3 col-sm-6">
                            <div class="AgencyArea-item" skip-src="/ZYPlanGuid/checkplanmanager" title="审核计划">
                                <div class="AgencyArea-head">
                                    <i class="glyphicon glyphicon-check"></i>
                                    <span class="pull-right">计划待审核</span>
                                </div>
                                <span class="text-muted">待审核数量</span>
                                <h3 id="daiban1" class="modal-title">0</h3>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="AgencyArea-item" skip-src="/ZYPlanGuid/planmanager" title="下发计划">
                                <div class="AgencyArea-head">
                                    <i class="glyphicon glyphicon-send"></i>
                                    <span class="pull-right">计划待下发</span>
                                </div>
                                <span class="text-muted">待下发数量</span>
                                <h3 id="daiban2" class="modal-title">0</h3>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="AgencyArea-item" skip-src="/QAauthPass" title="QA入库">
                                <div class="AgencyArea-head">
                                    <i class="glyphicon glyphicon-log-out"></i>
                                    <span class="pull-right">QA待入库</span>
                                </div>
                                <span class="text-muted">待入库数量</span>
                                <h3 id="daiban3" class="modal-title">0</h3>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="AgencyArea-item" skip-src="/BatchMaterielBalanceStatistic" title="批物料平衡统计">
                                <div class="AgencyArea-head">
                                    <i class="glyphicon glyphicon-pencil"></i>
                                    <span class="pull-right">物料平衡待确认</span>
                                </div>
                                <span class="text-muted">待确认数量</span>
                                <h3 id="daiban4" class="modal-title">0</h3>
                            </div>
                        </div>
{#                        <div class="col-md-3" skip-src="/BatchMaterielBalanceStatistic" title="设备故障待维修">#}
{#                            <div class="AgencyArea-item">#}
{#                                <h3 id="daiban4">0</h3>#}
{#                                <span><i class="glyphicon glyphicon-pencil"></i> 设备故障待维修</span>#}
{#                            </div>#}
{#                        </div>#}
{#                        <div class="col-md-3" skip-src="/BatchMaterielBalanceStatistic" title="设备故障待完成">#}
{#                            <div class="AgencyArea-item">#}
{#                                <h3 id="daiban4">0</h3>#}
{#                                <span><i class="glyphicon glyphicon-pencil"></i> 设备故障待完成</span>#}
{#                            </div>#}
{#                        </div>#}
{#                        <div class="col-md-3" skip-src="/BatchMaterielBalanceStatistic" title="设备检修待完成">#}
{#                            <div class="AgencyArea-item">#}
{#                                <h3 id="daiban4">0</h3>#}
{#                                <span><i class="glyphicon glyphicon-pencil"></i> 设备检修待完成</span>#}
{#                            </div>#}
{#                        </div>#}
{#                        <div class="col-md-3" skip-src="/BatchMaterielBalanceStatistic" title="设备检修待审核">#}
{#                            <div class="AgencyArea-item">#}
{#                                <h3 id="daiban4">0</h3>#}
{#                                <span><i class="glyphicon glyphicon-pencil"></i> 设备检修待审核</span>#}
{#                            </div>#}
{#                        </div>#}
                    </div>
                    <div id="compareBox" style="width: 100%;width: 100%;margin-bottom:20px;padding: 10px;background: #fff;border-radius: 5px;">
                        <div id="CompareMain" style="width: 760px; height: 360px;"></div>
                    </div>
                    <div class="col-md-12" style="margin-bottom: 20px;">
                        <div class="row">
                            <div class="col-md-8 col-sm-8" style="padding-left: 0">
                                <div class="" style="background: #fff;height: 130px;margin-bottom: 15px;border-radius: 5px;padding: 15px 0;">
                                    <div class="col-md-9">
                                        <p style="margin-bottom: 40px;">生产数据</p>
                                        <form class="form-inline">
                                            <div class="form-group" style="white-space: nowrap;">
                                                <div class="input-group input-append date col-sm-4">
                                                    <input type="text" value="" id="start_date" class="form-control" readonly>
                                                    <span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                                                </div>
                                                <div class="input-group input-append date col-sm-4">
                                                    <input type="text" value="" id="over_date" class="form-control" readonly>
                                                    <span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                                                </div>
                                                <button type="button" class="btn btn-primary">查询</button>
                                                <button type="button" class="btn btn-primary">重置</button>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="col-md-3">
                                        <p class="text-right" style="margin-top: 50px;color: #00bbee;font-size: 22px;">0</p>
                                    </div>
                                </div>
                                <div class="" style="background: #fff;height: 130px;border-radius: 5px;padding: 15px 0;">
                                    <div class="col-md-9">
                                        <p style="margin-bottom: 40px;">生产成本</p>
                                        <form class="form-inline">
                                            <div class="form-group" style="white-space: nowrap;">
                                                <div class="input-group input-append date col-sm-4">
                                                    <input type="text" value="" id="" class="form-control" readonly>
                                                    <span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                                                </div>
                                                <div class="input-group input-append date col-sm-4">
                                                    <input type="text" value="" id="" class="form-control" readonly>
                                                    <span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                                                </div>
                                                <button type="button" class="btn btn-primary">查询</button>
                                                <button type="button" class="btn btn-primary">重置</button>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="col-md-3">
                                        <p class="text-right" style="margin-top: 50px;color: #00bbee;font-size: 22px;">0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 col-sm-4" style="background:#fff;height: 275px;border-radius: 5px;padding: 15px;">
                                <div id="pieBox" style="width: 100%;height: 100%;">
                                    <div id="pie" style="width: 250px;height: 250px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-sm-12">
                    <div class="row">
                        <div class="col-md-12">
                            <div id='calendar' style="width: 100%;background: #fff;padding: 15px;border-radius: 5px;"></div>
                            <div class="col-md-12 col-sm-12" style="background: #d2d2d2;margin-bottom: 20px;">
                                <div class="row">
                                    <div class="col-md-4">
                                        <p class="bg-proceed text-center">维保</p>
                                    </div>
                                    <div class="col-md-4">
                                        <p class="bg-backlog text-center">休息</p>
                                    </div>
                                    <div class="col-md-4">
                                        <p class="bg-urgency text-center">紧急</p>
                                    </div>
                                </div>
                            </div>
                            <div class="panel panel-widget" style="background: #e3e3e3;">
                                <div class="panel-heading">制药计划待处理列表<a href="javascript:;" id="toZYPlanManage" style="float: right">去处理</a></div>
                                <div class="panel-body">
                                    <table id="planTable" class="table table-striped"></table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="../static/js/echarts.common.min.js"></script>
    <script type="text/javascript" src="../static/js/moment.min.js"></script>
    <script type="text/javascript" src="../static/js/jquery-3.3.1.min.js"></script>
    <script type="text/javascript" src="../static/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../static/js/bootstrap-table.min.js"></script>
    <script type="text/javascript" src="../static/js/bootstrap-table-zh-CN.min.js"></script>
    <script type="text/javascript" src="../static/js/bootstrap-datetimepicker.min.js"></script>
    <script type="text/javascript" src="../static/js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../static/js/fullcalendar.min.js"></script>
    <script type="text/javascript" src="../static/js/zh-cn.js"></script>
    <script type="text/javascript">
        //chart0
        $(document).ready(function () {
            //待办事项数量 a b c d
            $.ajax({
                url: '/souyesearch',
                method: 'get',
                success: function (data) {
                    data = JSON.parse(data)
                    $("#daiban1").html(data.A)
                    $("#daiban2").html(data.B)
                    $("#daiban3").html(data.C)
                    $("#daiban4").html(data.D)
                },
                error: function () {
                    alert("获取待办数据失败，请稍后重试！")
                }
            });
            $("#planTable").bootstrapTable({
                url:'/maindaiban',
                method: 'get',
                height:320,
                columns: [{
                    field: 'BrandName',
                    title: '品名'
                }, {
                    field: 'BatchID',
                    title: '批次号'
                }, {
                    field: 'PlanStatus',
                    title: '计划状态',
                    formatter:function(value,row,index){
                        if (value == 10){
                            return '新增计划'
                        }else if(value == 11){
                            return '审核计划'
                        }else if(value == 20){
                            return '下发计划'
                        }else if(value == 40){
                            return '撤回计划'
                        }else if(value == 50){
                            return '执行计划'
                        }else if(value == 60){
                            return '完成计划'
                        }else if(value == 70){
                            return 'QA入库'
                        }
                    }
                }]
            })

            //有此权限时增加tabs跳转到操作页面 审核-下发-放行-物料平衡
            $(".AgencyArea-item").on('click',function(){
                var text = $(this).attr("title")
                var src = $(this).attr("skip-src")
                $.ajax({
                    url: '/ZYPlanGuid/menuRedirect',
                    method: 'POST',
                    data: {
                        menuName: text
                    },
                    beforeSend:function (){
                        $("#loadingModal").modal('show');
                    },
                    success: function (data) {
                        if (data == "OK") {
                            $("#loadingModal").modal('hide');
                            addTab(text,src)
                        }else{
                            $("#loadingModal").modal('hide');
                            $.messager.alert('提示', data, 'info');
                        }
                    },
                    error: function () {
                        $("#loadingModal").modal('hide');
                        alert("请求失败，请稍后重试！")
                    }
                });
            })

            //时间选择控件
            $('.date').datetimepicker({
                autoclose: true, //选择完成自动关闭下拉框
                minView: 2,
                startView: 2, //从日开始选
                format: 'yyyy-mm-dd',
                todayBtn: true,
            });
            $("#start_date").val(myformatter(new Date()))
            function myformatter(date){
                var y = date.getFullYear();
                var m = date.getMonth()+1;
                var d = date.getDate();
                return y+'-'+(m<10?('0'+m):m)+'-'+( d<10?('0'+d):d);
            }

            //投入产出数据图表
            var myDiv = document.getElementById("CompareMain")
            var myChartContainer = function () {
                var width = $("#compareBox").width()
                myDiv.style.width = width +'px';
            };
            myChartContainer();
            myChart = echarts.init(myDiv)
            myChart.showLoading();
            $.ajax({
                url: "/HomePageHistogram",
                type: "get",
                dataType: "json",
                traditional:true,
                success: function (data) {
                    myChart.hideLoading();
                    myChart.setOption(option = {
                        title:{
                            text: data[0].time + "-数据对比"
                        },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'shadow'
                            }
                        },
                        legend: {
                            data: ['投入量', '产出量', '得率']
                        },
                        toolbox: {
                            feature: {
                                dataView: {show: true, readOnly: false},
                                magicType: {show: true, type: ['line', 'bar']},
                                restore: {show: true},
                                saveAsImage: {show: true}
                            }
                        },
                        dataZoom : {
                            show : true,
                            realtime : true,
                            start : 50,
                            end : 100
                        },
                        xAxis: {
                            type: 'category',
                            data: data[0].batch
                        },
                        yAxis: [
                            {
                                type: 'value',
                                name: '重量',
                                min: 0,
                                interval: 500,
                                axisLabel: {
                                    formatter: '{value} kg'
                                }
                            }, {
                                type: 'value',
                                name: '百分比',
                                min: 0,
                                max: 100,
                                interval: 10,
                                axisLabel: {
                                    formatter: '{value} %'
                                }
                            }
                        ],
                        series: [{
                            name: "投入量",
                            type: 'bar',
                            label: {
                                normal: {
                                    show: true,
                                    position: 'top'
                                }
                            },
                            itemStyle:{
                                normal:{
                                    color:'#90ed7d'
                                }
                            },
                            data: data[0].input
                        }, {
                            name: "产出量",
                            type: 'bar',
                            label: {
                                normal: {
                                    show: true,
                                    position: 'top'
                                }
                            },
                            itemStyle:{
                                normal:{
                                    color:'#f7a35c'
                                }
                            },
                            data: data[0].output
                        }, {
                            name: "得率",
                            type: 'bar',
                            yAxisIndex: 1,
                            label: {
                                normal: {
                                    show: true,
                                    position: 'top',
                                    formatter: '{c} %'
                                }
                            },
                            itemStyle:{
                                normal:{
                                    color:'#7cb5ec'
                                }
                            },
                            data: data[0].sampling_quantity
                        }]
                    });
                    myChart.setOption(option);
                }
            })
            parent.$(window).resize(function(){
                myChartContainer();
                myChart.resize();
            })

            //饼图
            var myPie = document.getElementById("pie")
            var myPieChartContainer = function () {
                var width = $("#pieBox").width()
                myPie.style.width = width +'px';
            };
            myPieChartContainer();
            myPieChart = echarts.init(myPie)
            myPieChart.hideLoading();
            myPieChart.setOption(option = {
                tooltip : {
                    trigger: 'item',
                    formatter: "{a} <br/>{b} : {c} ({d}%)"
                },
                legend: {
                    orient : 'vertical',
                    x : 'left',
                    data:['something1','something2','something3','something4','something5']
                },
                toolbox: {
                    show : true,
                    feature : {
                        mark : {show: true},
                        dataView : {show: true, readOnly: false},
                        magicType : {
                            show: true,
                            type: ['pie', 'funnel'],
                            option: {
                                funnel: {
                                    x: '25%',
                                    width: '50%',
                                    funnelAlign: 'center',
                                    max: 1548
                                }
                            }
                        },
                        restore : {show: true},
                        saveAsImage : {show: true}
                    }
                },
                calculable : true,
                series : [
                    {
                        name:'something',
                        type:'pie',
                        radius : ['50%', '70%'],
                        itemStyle : {
                            normal : {
                                label : {
                                    show : false
                                },
                                labelLine : {
                                    show : false
                                }
                            },
                            emphasis : {
                                label : {
                                    show : true,
                                    position : 'center',
                                    textStyle : {
                                        fontSize : '14',
                                        fontWeight : 'bold'
                                    }
                                }
                            }
                        },
                        data:[
                            {value:335, name:'something1'},
                            {value:310, name:'something2'},
                            {value:234, name:'something3'},
                            {value:135, name:'something4'},
                            {value:1548, name:'somethin5'}
                        ]
                    }
                ]
            });
            myPieChart.setOption(option);
            parent.$(window).resize(function(){
                myPieChartContainer();
                myPieChart.resize();
            })

            //日历排产
            $('#calendar').fullCalendar({
                locale:'zh-cn',
                weekNumbers: true, //是否在日历中显示第几周
                eventLimit: true, // allow "more" link when too many events
                height:310,
                events: function(start,end,timezone,callback){
                    var events = []
                    $.ajax({
                        url: '/systemManager_model/plantCalendarSchedulingSelect',
                        type: 'get',
                        success: function (data) {
                            data = JSON.parse(data)
                            var _id = ""
                            var _title = ""
                            var _start = ""
                            var _color = ""
                            for (var i=0;i<data.length;i++){
                                _id = data[i].ID
                                _title = data[i].title
                                _start = data[i].start
                                _color = data[i].color
                                events.push({
                                    ID:_id,
                                    title:_title,
                                    start:_start,
                                    color:_color
                                })
                            }
                            callback(events);
                        },
                        error: function () {
                            bootbox.alert("请求失败")
                        }
                     });
                 }
             });

            //增加tabs跳转到制药计划管理
            $("#toZYPlanManage").on('click',function(){
                addTab("制药计划管理","/ZYPlanManage")
            })
            //增加tabs跳转到备件管理
            $("#toEquipmentspare").on('click',function(){
                addTab("设备备件管理","/equipmentspare")
            })
        });
        //按钮点击后添加选项卡
        function addTab(title, url) {
            if (parent.$('.easyui-tabs1').tabs('exists', title)) {
                parent.$('.easyui-tabs1').tabs('select', title);
            }
            else {
                var content = '<iframe class="page-iframe" src="' + url + '" frameborder="no" border="no" height="100%" width="100%" scrolling="auto"></iframe>';
                parent.$('.easyui-tabs1').tabs('add', {
                    title: title,
                    content: content,
                    closable: true
                });
            }
        }
    </script>
</body>
</html>